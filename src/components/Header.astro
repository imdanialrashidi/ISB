---
import contactsData from "../content/contacts.json";
import { toPersianDigits } from "../lib/locale";
import type { ContactsContent } from "../lib/types";

const contacts = contactsData as ContactsContent;
const mainPhone = contacts.phones[0];
const mainPhoneFa = toPersianDigits(mainPhone.number);
const whatsappHref =
  contacts.whatsapp.status === "active" && contacts.whatsapp.number
    ? `https://wa.me/${contacts.whatsapp.number.replace(/[^\d]/g, "")}`
    : "/contact#whatsapp";

const navItems = [
  { href: "/", label: "خانه" },
  { href: "/about", label: "درباره ما" },
  { href: "/services", label: "خدمات" },
  { href: "/projects", label: "پروژه‌ها" },
  { href: "/contact", label: "تماس با ما" },
  { href: "/blog", label: "بلاگ" },
];
---

<header
  id="site-header"
  class="border-brand-border/70 bg-brand-surface/95 sticky top-0 z-50 border-b backdrop-blur"
>
  <div class="container-wrap py-3">
    <div class="flex items-center justify-between gap-3">
      <a
        href="/"
        class="text-base font-bold text-brand-primary sm:text-lg"
        aria-label="صفحه اصلی ایمن صنعت باتاب"
      >
        ایمن صنعت باتاب <span class="latin-text text-brand-accent">ISB</span>
      </a>

      <nav
        class="hidden items-center gap-5 text-sm font-medium text-brand-text md:flex"
        aria-label="منوی اصلی"
      >
        {
          navItems.map((item) => (
            <a href={item.href} class="hover:text-brand-accent focus-visible:text-brand-accent">
              {item.label}
            </a>
          ))
        }
      </nav>

      <div class="hidden items-center gap-2 md:flex">
        <a
          href={`tel:${mainPhone.tel}`}
          class="rounded-full border border-brand-primary px-3 py-2 text-xs font-semibold text-brand-primary hover:bg-brand-primary hover:text-white"
          aria-label={`تماس تلفنی با ${mainPhone.label}`}
        >
          تماس: <span class="num-text">{mainPhoneFa}</span>
        </a>
        <a
          href={whatsappHref}
          target={whatsappHref.startsWith("https://wa.me/") ? "_blank" : undefined}
          rel={whatsappHref.startsWith("https://wa.me/") ? "noopener noreferrer" : undefined}
          class="rounded-full bg-brand-accent px-3 py-2 text-xs font-semibold text-white hover:bg-brand-primary"
          aria-label="ارسال پیام در واتساپ"
        >
          واتساپ
        </a>
      </div>

      <button
        id="mobile-menu-button"
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-brand-border bg-white text-brand-primary shadow-sm transition hover:border-brand-accent hover:text-brand-accent md:hidden"
        aria-label="باز کردن منو"
        aria-expanded="false"
        aria-controls="mobile-menu-panel"
      >
        <svg
          id="menu-icon-open"
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          viewBox="0 0 24 24"
          fill="none"
          aria-hidden="true"
        >
          <path
            d="M4 7H20M4 12H20M4 17H20"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"></path>
        </svg>
        <svg
          id="menu-icon-close"
          xmlns="http://www.w3.org/2000/svg"
          class="hidden h-5 w-5"
          viewBox="0 0 24 24"
          fill="none"
          aria-hidden="true"
        >
          <path
            d="M6 6L18 18M18 6L6 18"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"></path>
        </svg>
      </button>
    </div>
  </div>

  <div
    id="mobile-menu-overlay"
    class="bg-brand-primary/30 pointer-events-none fixed inset-0 z-40 opacity-0 transition md:hidden"
  >
  </div>

  <div
    id="mobile-menu-panel"
    class="pointer-events-none fixed inset-x-4 top-[74px] z-50 max-h-[calc(100vh-96px)] overflow-y-auto rounded-2xl border border-brand-border bg-white p-4 opacity-0 shadow-soft transition md:hidden"
    aria-label="منوی موبایل"
  >
    <nav class="space-y-1" aria-label="لینک‌های موبایل">
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class="mobile-menu-link flex items-center justify-between rounded-xl px-3 py-3 text-sm font-semibold text-brand-text transition hover:bg-slate-50 hover:text-brand-accent"
          >
            <span>{item.label}</span>
            <span class="text-brand-muted">←</span>
          </a>
        ))
      }
    </nav>
    <div class="mt-4 grid grid-cols-1 gap-2 sm:grid-cols-2">
      <a
        href={`tel:${mainPhone.tel}`}
        class="rounded-xl border border-brand-primary px-4 py-3 text-center text-sm font-semibold text-brand-primary hover:bg-brand-primary hover:text-white"
      >
        تماس فوری
      </a>
      <a
        href={whatsappHref}
        target={whatsappHref.startsWith("https://wa.me/") ? "_blank" : undefined}
        rel={whatsappHref.startsWith("https://wa.me/") ? "noopener noreferrer" : undefined}
        class="rounded-xl bg-brand-accent px-4 py-3 text-center text-sm font-semibold text-white hover:bg-brand-primary"
      >
        پیام واتساپ
      </a>
    </div>
  </div>
</header>

<script is:inline>
  const button = document.getElementById("mobile-menu-button");
  const panel = document.getElementById("mobile-menu-panel");
  const overlay = document.getElementById("mobile-menu-overlay");
  const openIcon = document.getElementById("menu-icon-open");
  const closeIcon = document.getElementById("menu-icon-close");
  const links = document.querySelectorAll(".mobile-menu-link");

  if (button && panel && overlay && openIcon && closeIcon) {
    let isOpen = false;

    const setMenuState = (open) => {
      isOpen = open;
      button.setAttribute("aria-expanded", open ? "true" : "false");
      button.setAttribute("aria-label", open ? "بستن منو" : "باز کردن منو");
      panel.classList.toggle("opacity-0", !open);
      panel.classList.toggle("pointer-events-none", !open);
      overlay.classList.toggle("opacity-0", !open);
      overlay.classList.toggle("pointer-events-none", !open);
      openIcon.classList.toggle("hidden", open);
      closeIcon.classList.toggle("hidden", !open);
      document.body.classList.toggle("overflow-hidden", open);
    };

    button.addEventListener("click", () => setMenuState(!isOpen));
    overlay.addEventListener("click", () => setMenuState(false));

    links.forEach((link) => {
      link.addEventListener("click", () => setMenuState(false));
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && isOpen) {
        setMenuState(false);
      }
    });
  }
</script>
